{% extends 'layout/base.html' %}
{% load static %}

{% block title %} CRUDify {% endblock %}

{% block content %}

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {% for field in form %}
    <div class="mb-3">
        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
        {{ field }}
    </div>
    {% endfor %}
    
    <!-- Live Capture Section -->
    <div class="mb-3">
        <label class="form-label">Live Capture</label>
        <div class="row">
            <div class="col-md-6">
                <div class="video-container mb-3">
                    <video id="video" width="300" height="200" autoplay class="border rounded"></video>
                </div>
                <button type="button" id="capture-btn" class="btn btn-secondary">Capture Photo</button>
            </div>
            <div class="col-md-6">
                <canvas id="canvas" width="300" height="200" class="border rounded d-none"></canvas>
                <img id="photo" src="{{ user.picture.url }}" alt="Your photo" width="300" height="200" class="border rounded">
            </div>
        </div>
        <input type="hidden" id="image_data" name="image_data">
    </div>

    <button type="submit" class="form-submit btn btn-login w-100" style="background-color: #3d5a71; color: white">Simpan</button>
</form>

<!-- JavaScript for Live Capture -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const photo = document.getElementById('photo');
    const captureBtn = document.getElementById('capture-btn');
    const imageData = document.getElementById('image_data');
    
    // Access webcam
    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                video.srcObject = stream;
            })
            .catch(function(error) {
                console.error("Error accessing webcam:", error);
            });
    }
    
    // Capture image
    captureBtn.addEventListener('click', function() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Convert to data URL and display
        const imageUrl = canvas.toDataURL('image/png');
        photo.setAttribute('src', imageUrl);
        imageData.value = imageUrl;
        
        // Show the photo and hide canvas
        photo.classList.remove('d-none');
        canvas.classList.add('d-none');
    });
});
</script>

{% endblock %}